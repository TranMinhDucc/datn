<?php

namespace App\Http\Controllers\Client;

use App\Http\Controllers\Controller;
use App\Models\Coupon;
use App\Models\Order;
use App\Models\OrderItem;
use App\Models\PartnerLocationCode;
use App\Models\PaymentMethod;
use App\Models\Product;
use App\Models\ProductVariant;
use App\Models\Province;
use App\Models\Setting;
use App\Models\ShippingFee;
use App\Models\User;
use App\Services\Shipping\GhnService;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Log;

class CheckoutController extends Controller
{
    protected $ghnService;

    public function __construct(GhnService $ghnService)
    {
        $this->ghnService = $ghnService;
    }
    public function index()
    {
        $user = auth()->user();
        $addresses = $user->shippingAddresses;
        $defaultAddress = $addresses->firstWhere('is_default', 1);
        $paymentMethods = PaymentMethod::where('active', 1)->get();
        $provinces = Province::all();

        $shippingFee = ['success' => false, 'data' => ['total' => 0]];

        // T√≠nh ph√≠ ship cho ƒë·ªãa ch·ªâ m·∫∑c ƒë·ªãnh ngay khi t·∫£i trang
        if ($defaultAddress && $defaultAddress->district_id && $defaultAddress->ward_id) {
            $districtCode = PartnerLocationCode::where([
                ['location_id', $defaultAddress->district_id],
                ['type', 'district'],
                ['partner_code', 'ghn']
            ])->value('partner_id');

            $wardCode = PartnerLocationCode::where([
                ['location_id', $defaultAddress->ward_id],
                ['type', 'ward'],
                ['partner_code', 'ghn']
            ])->value('partner_id');

            if ($districtCode && $wardCode) {
                $payload = [
                    'service_type_id' => 2,
                    'from_district_id' => config('services.ghn.from_district_id'),
                    'to_district_id' => (int) $districtCode,
                    'to_ward_code' => (string) $wardCode,
                    'weight' => 1000, // Gi·∫£ s·ª≠ tr·ªçng l∆∞·ª£ng m·∫∑c ƒë·ªãnh
                    'length' => 10,
                    'width' => 15,
                    'height' => 10
                ];

                $shippingFee = $this->ghnService->calculateShippingFee($payload);
            }
        }

        return view('client.checkout.index', compact(
            'addresses',
            'defaultAddress',
            'paymentMethods',
            'shippingFee',
            'provinces'
        ));
    }
    // CheckoutController.php
    public function calculateShippingFee(Request $request)
    {
        $addressId = $request->get('address_id');
        $cartItems = $request->get('cartItems', []);

        $address = auth()->user()->shippingAddresses()->find($addressId);
        if (!$address) {
            return response()->json(['success' => false, 'message' => 'ƒê·ªãa ch·ªâ kh√¥ng t·ªìn t·∫°i.']);
        }

        $districtCode = PartnerLocationCode::where([
            ['location_id', $address->district_id],
            ['type', 'district'],
            ['partner_code', 'ghn']
        ])->value('partner_id');

        $wardCode = PartnerLocationCode::where([
            ['location_id', $address->ward_id],
            ['type', 'ward'],
            ['partner_code', 'ghn']
        ])->value('partner_id');

        if (!$districtCode || !$wardCode) {
            return response()->json(['success' => false, 'message' => 'Kh√¥ng l·∫•y ƒë∆∞·ª£c m√£ ƒë·ªëi t√°c.']);
        }

        // T√≠nh to√°n k√≠ch th∆∞·ªõc v√† tr·ªçng l∆∞·ª£ng ƒë∆°n h√†ng
        $totalWeight = 0;
        $maxLength = 0;
        $maxWidth = 0;
        $totalHeight = 0;

        foreach ($cartItems as $item) {
            // L·∫•y th√¥ng tin s·∫£n ph·∫©m t·ª´ database
            $product = Product::find($item['id']);
            if (!$product) continue;

            $variant = isset($item['variant_id']) ? ProductVariant::find($item['variant_id']) : null;

            $weight = $variant ? $variant->weight : $product->weight;
            $length = $variant ? $variant->length : $product->length;
            $width = $variant ? $variant->width : $product->width;
            $height = $variant ? $variant->height : $product->height;

            $quantity = $item['quantity'] ?? 1;

            $totalWeight += $weight * $quantity;
            $maxLength = max($maxLength, $length);
            $maxWidth = max($maxWidth, $width);
            $totalHeight += $height * $quantity;
        }

        // G·ªçi API GHN ƒë·ªÉ t√≠nh ph√≠ v·∫≠n chuy·ªÉn
        $payload = [
            'service_type_id' => 2,
            'from_district_id' => config('services.ghn.from_district_id'),
            'to_district_id' => (int) $districtCode,
            'to_ward_code' => (string) $wardCode,
            'weight' => $totalWeight ?: 1000, // fallback n·∫øu kh√¥ng c√≥ weight
            'length' => $maxLength ?: 10,
            'width' => $maxWidth ?: 15,
            'height' => $totalHeight ?: 10
        ];

        $shippingFee = $this->ghnService->calculateShippingFee($payload);

        return response()->json([
            'success' => true,
            'data' => $shippingFee['data'] ?? [],
            'total' => $shippingFee['data']['total'] ?? 0,
        ]);
    }


    public function placeOrder(Request $request)
    {
        try {
            DB::beginTransaction(); // üü¢ B·∫ÆT ƒê·∫¶U TRANSACTION
            Log::info('üì• D·ªØ li·ªáu nh·∫≠n:', $request->all());

            if (!$request->payment_method_id || !$request->shipping_address_id) {
                return response()->json(['success' => false, 'message' => 'Thi·∫øu th√¥ng tin b·∫Øt bu·ªôc.']);
            }

            $user = auth()->user();
            if (!$user) return response()->json(['success' => false, 'message' => 'B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p.'], 401);

            $cartItems         = $request->cartItems;
            $shippingAddressId = $request->shipping_address_id;
            $paymentMethodId   = $request->payment_method_id;
            $couponId          = $request->coupon_id;
            $shippingCouponId  = $request->shipping_coupon_id;
            $discountAmount    = floatval($request->discount_amount);
            $shippingFee       = floatval($request->shipping_fee);
            $taxAmount         = floatval($request->tax_amount);

            $subtotal = collect($cartItems)->sum(fn($item) => $item['price'] * $item['quantity']);
            $totalAmount = max(0, $subtotal + $shippingFee - $discountAmount + $taxAmount);

            $paymentMethod = \App\Models\PaymentMethod::find($paymentMethodId);
            if (!$paymentMethod) return response()->json(['success' => false, 'message' => 'Ph∆∞∆°ng th·ª©c thanh to√°n kh√¥ng h·ª£p l·ªá.'], 400);

            $isPaid = 0;
            $paymentStatus = 'unpaid';
            if ($paymentMethod->code === 'wallet') {
                if ($user->balance < $totalAmount) return response()->json(['success' => false, 'message' => 'S·ªë d∆∞ v√≠ kh√¥ng ƒë·ªß ƒë·ªÉ thanh to√°n.'], 400);
                $user->decrement('balance', $totalAmount);
                $isPaid = 1;
                $paymentStatus = 'paid';
            }

            if ($couponId) {
                $coupon = \App\Models\Coupon::find($couponId);
                if (!$coupon) return response()->json(['success' => false, 'message' => 'M√£ gi·∫£m gi√° kh√¥ng t·ªìn t·∫°i.'], 400);

                $userUsed = DB::table('coupon_user')->where('coupon_id', $couponId)->where('user_id', $user->id)->count();
                if ($coupon->per_user_limit > 0 && $userUsed >= $coupon->per_user_limit) {
                    return response()->json(['success' => false, 'message' => 'B·∫°n ƒë√£ s·ª≠ d·ª•ng m√£ gi·∫£m gi√° n√†y ƒë·ªß s·ªë l·∫ßn cho ph√©p.'], 400);
                }
            }

            $order = Order::create([
                'order_code'         => 'ORD' . now()->timestamp,
                'user_id'            => $user->id,
                'address_id'         => $shippingAddressId,
                'payment_method_id'  => $paymentMethodId,
                'coupon_code'        => $couponId ? optional($coupon)->code : null,
                'coupon_id'          => $couponId,
                'shipping_coupon_id' => $shippingCouponId,
                'discount_amount'    => $discountAmount,
                'tax_amount'         => $taxAmount,
                'shipping_fee'       => $shippingFee,
                'subtotal'           => $subtotal,
                'total_amount'       => $totalAmount,
                'is_paid'            => $isPaid,
                'payment_status'     => $paymentStatus,
                'status'             => 'pending',
                'ip_address'         => request()->ip(),
                'user_agent'         => request()->userAgent(),
            ]);

            if (!$order || !$order->id) {
                Log::error('‚ùå Order::create() tr·∫£ v·ªÅ null.');
                DB::rollBack();
                return response()->json(['success' => false, 'message' => 'Kh√¥ng th·ªÉ t·∫°o ƒë∆°n h√†ng.'], 500);
            }

            Log::info('‚úÖ ƒê∆°n h√†ng ƒë√£ t·∫°o:', ['order_id' => $order->id]);

            $totalWeight = 0;
            $maxLength = 0;
            $maxWidth = 0;
            $totalHeight = 0;

            foreach ($cartItems as $item) {
                $variant = null;
                $product = null;

                if (!empty($item['variant_id'])) {
                    $variant = ProductVariant::where('id', $item['variant_id'])->lockForUpdate()->first(); // üîí LOCK VARIANT

                    if ($variant) {
                        Log::info('‚úÖ ƒê√£ t√¨m th·∫•y Variant:', $variant->toArray());
                        $product = $variant->product;
                    } else {
                        Log::warning('‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y Variant v·ªõi ID: ' . $item['variant_id']);
                        $product = Product::find($item['id']);
                    }
                } else {
                    $product = Product::where('id', $item['id'])->lockForUpdate()->first(); // üîí LOCK PRODUCT
                    Log::info('‚ÑπÔ∏è Kh√¥ng c√≥ variant_id trong item, d√πng s·∫£n ph·∫©m g·ªëc.');
                }

                if (!$product) {
                    DB::rollBack();
                    return response()->json(['success' => false, 'message' => 'Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m.'], 400);
                }

                // ‚úÖ KI·ªÇM TRA V√Ä TR·ª™ T·ªíN KHO
                $stock = $variant?->stock_quantity ?? $product->stock_quantity;
                if ($stock < $item['quantity']) {
                    DB::rollBack();
                    return response()->json(['success' => false, 'message' => 'S·∫£n ph·∫©m "' . $product->name . '" kh√¥ng ƒë·ªß t·ªìn kho.'], 400);
                }

                if ($variant) {
                    $variant->decrement('quantity', $item['quantity']);
                } else {
                    $product->decrement('stock_quantity', $item['quantity']);
                }

                // ‚úÖ TH√îNG TIN ƒê∆†N H√ÄNG CHI TI·∫æT
                $weight = $variant?->weight ?? $product?->weight ?? 0;
                $length = $variant?->length ?? $product?->length ?? 0;
                $width  = $variant?->width  ?? $product?->width  ?? 0;
                $height = $variant?->height ?? $product?->height ?? 0;

                $totalWeight += $weight * $item['quantity'];
                $maxLength = max($maxLength, $length);
                $maxWidth  = max($maxWidth, $width);
                $totalHeight += $height * $item['quantity'];

                $order->orderItems()->create([
                    'product_id'         => $product->id,
                    'product_variant_id' => $variant?->id,
                    'product_name'       => $item['name'],
                    'sku'                => $item['sku'] ?? '',
                    'image_url'          => $item['image'] ?? '',
                    'variant_values'     => json_encode($item['attributes'] ?? []),
                    'price'              => $item['price'],
                    'quantity'           => $item['quantity'],
                    'total_price'        => $item['price'] * $item['quantity'],
                    'weight'             => $weight,
                    'length'             => $length,
                    'width'              => $width,
                    'height'             => $height,
                ]);
            }

            $order->update([
                'total_weight' => $totalWeight,
                'max_length'   => $maxLength,
                'max_width'    => $maxWidth,
                'total_height' => $totalHeight,
            ]);

            $now = now();

            if ($couponId) {
                DB::table('coupon_user')->insertOrIgnore([
                    'coupon_id'  => $couponId,
                    'user_id'    => $user->id,
                    'created_at' => $now,
                    'updated_at' => $now,
                ]);
                DB::table('coupons')->where('id', $couponId)->increment('used_count');
            }

            if ($shippingCouponId) {
                DB::table('coupon_user')->insertOrIgnore([
                    'coupon_id'  => $shippingCouponId,
                    'user_id'    => $user->id,
                    'created_at' => $now,
                    'updated_at' => $now,
                ]);
                DB::table('coupons')->where('id', $shippingCouponId)->increment('used_count');
            }

            session()->put('order_id', $order->id);
            DB::commit(); // ‚úÖ K·∫æT TH√öC TRANSACTION

            return response()->json([
                'success'  => true,
                'message'  => 'ƒê·∫∑t h√†ng th√†nh c√¥ng!',
                'order_id' => $order->id,
            ]);
        } catch (\Throwable $e) {
            DB::rollBack(); // ‚ùå L·ªñI TH√å ROLLBACK
            Log::error('‚ùå L·ªói ƒë·∫∑t h√†ng: ' . $e->getMessage(), ['trace' => $e->getTraceAsString()]);
            return response()->json(['success' => false, 'message' => 'L·ªói h·ªá th·ªëng khi x·ª≠ l√Ω ƒë∆°n h√†ng.', 'error' => $e->getMessage()], 500);
        }
    }


    public function success()
    {
        $orderId = session()->pull('order_id'); // K√©o ra 1 l·∫ßn r·ªìi xo√° lu√¥n

        if (!$orderId) {
            return redirect()->route('client.home')->with('error', 'Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng.');
        }

        $order = \App\Models\Order::with(['orderItems', 'address'])->find($orderId);

        if (!$order) {
            return redirect()->route('client.home')->with('error', 'ƒê∆°n h√†ng kh√¥ng t·ªìn t·∫°i.');
        }

        return view('client.checkout.success', compact('order'))
            ->with('success', 'üéâ ƒê·∫∑t h√†ng th√†nh c√¥ng!');
    }

    private function calculateDiscount($couponId, $userId, $cartSubtotal)
    {
        if (!$couponId) return 0;

        $coupon = Coupon::find($couponId);
        $user = User::find($userId);
        if (!$coupon || !$coupon->active) return 0;
        if (now()->lt($coupon->start_date) || now()->gt($coupon->end_date)) return 0;
        if ($coupon->usage_limit > 0 && $coupon->used_count >= $coupon->usage_limit) return 0;
        if ($coupon->per_user_limit > 0) {
            $usedByUser = DB::table('coupon_user')->where('coupon_id', $couponId)->where('user_id', $userId)->count();
            if ($usedByUser >= $coupon->per_user_limit) return 0;
        }
        if ($coupon->only_for_new_users && !$user->is_new_user) return 0;
        if ($coupon->eligible_user_roles) {
            $allowedRoles = json_decode($coupon->eligible_user_roles, true);
            if (!in_array($user->role, $allowedRoles)) return 0;
        }
        if ($cartSubtotal < $coupon->min_order_amount) return 0;

        if ($coupon->value_type === 'percentage') {
            $discount = $cartSubtotal * ($coupon->discount_value / 100);
            return $coupon->max_discount_amount ? min($discount, $coupon->max_discount_amount) : $discount;
        }

        if ($coupon->value_type === 'fixed') return $coupon->discount_value;
        return 0;
    }
}
